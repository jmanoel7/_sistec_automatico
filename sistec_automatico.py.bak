# -*- coding: utf-8 -*-

import re
from time import sleep
from selenium.webdriver.common.by import By
from selenium.webdriver.support.select import Select
from selenium.common.exceptions import NoSuchElementException
from browser import get_browser

time1 = 10
time2 = 2
get_browser().get('https://sistec.mec.gov.br/')
sleep(time1)
xpath = '//*[@id="tipo"]'
while True:
    try:
        select_element = get_browser().find_element(By.XPATH, xpath)
    except NoSuchElementException:
        sleep(time2)
        continue
    break

select_object = Select(select_element)
campus_encoding = 'iso-8859-1'
campi = {}
campus_list = []
count = 0
all_available_options = select_object.options
for i in range(1, len(all_available_options)):
    option = all_available_options[i]
    line = option.text
    perfil = re.sub(r'^([A-Z\s]+).*INSTITUTO.*$', r'\1', line)
    perfil = re.sub(r'\s+$', r'', perfil)
    campus = u'CÂMPUS ' + re.sub(r'^.*CAMPUS\s+([A-ZÁÃÂÉẼÊÍĨÎÓÕÔÚŨÛÇ\s]+).*$', r'\1', line)
    campus = re.sub(r'\s+$', r'', campus)
    campus = campus.encode(campus_encoding)
    # AJUSTES PARA O IFG: INICIO
    if campus == u'CÂMPUS ÁGUAS LINDAS DE GOIÁS'.encode(campus_encoding):
        campus = u'CÂMPUS ÁGUAS LINDAS'.encode(campus_encoding)
    if campus == u'CÂMPUS VALPARAÍSO DE GOIÁS'.encode(campus_encoding):
        campus = u'CÂMPUS VALPARAÍSO'.encode(campus_encoding)
    # AJUSTES PARA O IFG: FIM
    if campus not in campus_list:
        campus_list.append(campus)
        baixar = True
    else:
        baixar = False
    cod_campus = option.get_attribute('value')
    tupla_campus = (cod_campus, campus, perfil, baixar)
    if count < 10:
        key = '0' + str(count)
    else:
        key = str(count)
    campi[key] = tupla_campus
    count = count + 1

# ORDENACAO DO DICIONARIO CAMPI
campi = {key: value for key, value in sorted(campi.items(), key=lambda item: item[1][1])}

# CONFIG COOKIE
cookie_phpsessid = get_browser().get_cookie('PHPSESSID')
# cookie_phpsessid = cookie_phpsessid['name'] + '=' + cookie_phpsessid['value']

# print informacoes
print(cookie_phpsessid)
print(campi)

# Acessa outra pagina web
get_browser().get('http://aguia:8080/sistec_download')
